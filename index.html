<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œæ—¶é—´ä¸åŠ ç­ç»Ÿè®¡ç³»ç»Ÿ - å¢å¼ºæ•°æ®å®‰å…¨ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f6fa;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .welcome-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .welcome-title {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .welcome-subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .feature-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .user-guide {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        
        .guide-step {
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .time-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin: 5px 0;
        }
        
        input, select, button, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .delete-btn {
            background: #e74c3c;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .edit-btn {
            background: #f39c12;
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .edit-btn:hover {
            background: #e67e22;
        }
        
        .update-btn {
            background: #9b59b6;
        }
        
        .update-btn:hover {
            background: #8e44ad;
        }
        
        .cancel-btn {
            background: #95a5a6;
        }
        
        .cancel-btn:hover {
            background: #7f8c8d;
        }
        
        .export-btn {
            background: #27ae60;
        }
        
        .export-btn:hover {
            background: #219a52;
        }
        
        .punch-btn {
            background: #e67e22;
            font-size: 16px;
            padding: 12px 20px;
            margin: 10px 0;
        }
        
        .punch-btn:hover {
            background: #d35400;
        }
        
        .supplement-btn {
            background: #9b59b6;
            font-size: 16px;
            padding: 12px 20px;
            margin: 10px 0;
        }
        
        .supplement-btn:hover {
            background: #8e44ad;
        }
        
        .punch-section {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
        }
        
        .punch-time {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .stats-section {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .calendar-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .calendar-nav button {
            background: #34495e;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-weekday {
            text-align: center;
            padding: 8px;
            background: #ecf0f1;
            font-weight: bold;
            font-size: 12px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            padding: 5px;
            border: 1px solid #ecf0f1;
            cursor: pointer;
            font-size: 12px;
            position: relative;
        }
        
        .calendar-day:hover {
            background: #f8f9fa;
        }
        
        .day-number {
            font-weight: bold;
        }
        
        .day-status {
            font-size: 10px;
            margin-top: 2px;
        }
        
        .work-status {
            color: #27ae60;
        }
        
        .leave-status {
            color: #e74c3c;
        }
        
        .rest-status {
            color: #7f8c8d;
        }
        
        .today {
            background: #3498db;
            color: white;
        }
        
        .other-month {
            color: #bdc3c7;
        }
        
        .period-day {
            background-color: rgba(52, 152, 219, 0.2);
        }
        
        .selected-day {
            background-color: rgba(155, 89, 182, 0.3);
        }
        
        .records-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .record-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .record-item:nth-child(odd) {
            background: #f9f7ff;
        }
        
        .record-item:nth-child(even) {
            background: #f0f8ff;
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .record-date {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weekday {
            font-size: 14px;
            color: #7f8c8d;
            background: rgba(127, 140, 141, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .record-type {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .work-day {
            background: #3498db;
            color: white;
        }
        
        .rest-day {
            background: #27ae60;
            color: white;
        }
        
        .leave-day {
            background: #9b59b6;
            color: white;
        }
        
        .time-blocks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .time-block {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .normal-work {
            border-left: 3px solid #3498db;
        }
        
        .overtime {
            border-left: 3px solid #e74c3c;
        }
        
        .leave-block {
            border-left: 3px solid #9b59b6;
        }
        
        .block-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .block-time {
            color: #666;
            font-size: 14px;
        }
        
        .block-duration {
            color: #e74c3c;
            font-weight: bold;
            font-size: 14px;
        }
        
        .overtime-duration {
            color: #e74c3c;
            font-weight: bold;
            font-size: 16px;
        }
        
        .leave-duration {
            color: #9b59b6;
            font-weight: bold;
            font-size: 14px;
        }
        
        .record-total {
            text-align: right;
            font-weight: bold;
            color: #2c3e50;
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 16px;
        }
        
        .empty-message {
            text-align: center;
            color: #7f8c8d;
            padding: 40px;
            font-style: italic;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .time-section {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .time-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .time-section-content {
            margin-top: 10px;
        }
        
        .leave-options {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }
        
        .leave-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-mode {
            border-left: 4px solid #f39c12;
            background: #fff9e6;
        }
        
        .button-group {
            display: flex;
            gap: 5px;
        }
        
        .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #9b59b6;
        }
        
        .settings-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .settings-content {
            margin-top: 15px;
        }
        
        .period-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .supplement-section {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .supplement-calendar {
            margin-top: 15px;
        }
        
        .selected-dates {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .selected-date-item {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 5px;
            font-size: 12px;
        }
        
        .backup-section {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .backup-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .backup-info {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .month-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .sort-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }
        
        .all-functions-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #e67e22;
        }
        
        .function-group {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .function-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .function-content {
            margin-top: 10px;
        }
        
        .data-status {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            border-left: 4px solid #27ae60;
        }
        
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            input, select, button {
                width: 100%;
            }
            
            .time-group {
                width: 100%;
                justify-content: space-between;
            }
            
            .leave-options {
                flex-direction: column;
                gap: 8px;
            }
            
            .feature-list {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .backup-options {
                flex-direction: column;
            }
            
            .sort-options {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¬¢è¿åŒºåŸŸ -->
        <div class="welcome-section">
            <div class="welcome-title">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨å·¥ä½œæ—¶é—´ç»Ÿè®¡ç³»ç»Ÿ - å¢å¼ºæ•°æ®å®‰å…¨ç‰ˆ</div>
            <div class="welcome-subtitle">å¤šé‡å¤‡ä»½æœºåˆ¶ï¼Œæ•°æ®æ›´å®‰å…¨</div>
            
            <div class="feature-list">
                <div class="feature-item">
                    <div>ğŸ“… æ—¥å†è§†å›¾</div>
                    <small>ç›´è§‚æŸ¥çœ‹æœˆåº¦è€ƒå‹¤</small>
                </div>
                <div class="feature-item">
                    <div>â° ä¸€é”®æ‰“å¡</div>
                    <small>å¿«é€Ÿè®°å½•å®Œæ•´å·¥ä½œæ—¥</small>
                </div>
                <div class="feature-item">
                    <div>ğŸ“Š æ•°æ®ç»Ÿè®¡</div>
                    <small>è‡ªåŠ¨ç”Ÿæˆæœˆåº¦æŠ¥è¡¨</small>
                </div>
                <div class="feature-item">
                    <div>ğŸ”§ è‡ªå®šä¹‰å‘¨æœŸ</div>
                    <small>çµæ´»è®¾ç½®ç»Ÿè®¡å‘¨æœŸ</small>
                </div>
                <div class="feature-item">
                    <div>ğŸ”„ è¡¥å¡åŠŸèƒ½</div>
                    <small>æ‰¹é‡è¡¥å½•æœªæ‰“å¡æ—¥æœŸ</small>
                </div>
                <div class="feature-item">
                    <div>ğŸ’¾ å¤šé‡å¤‡ä»½</div>
                    <small>æ•°æ®å®‰å…¨ä¸ä¸¢å¤±</small>
                </div>
            </div>
        </div>
        
        <!-- ä½¿ç”¨æŒ‡å— -->
        <div class="user-guide">
            <h3>ğŸ“– ä½¿ç”¨æŒ‡å—</h3>
            <div class="guide-step">1. <strong>ä¸€é”®æ‰“å¡</strong>ï¼šç‚¹å‡»æ©™è‰²æŒ‰é’®å¿«é€Ÿè®°å½•æ ‡å‡†å·¥ä½œæ—¥</div>
            <div class="guide-step">2. <strong>æ‰‹åŠ¨è®°å½•</strong>ï¼šé€‰æ‹©æ—¥æœŸå’Œå·¥ä½œç±»å‹ï¼Œè‡ªå®šä¹‰å·¥ä½œæ—¶é—´</div>
            <div class="guide-step">3. <strong>è¯·å‡è®°å½•</strong>ï¼šé€‰æ‹©è¯·å‡ç±»å‹ï¼Œæ”¯æŒå…¨å¤©/ä¸Šåˆ/ä¸‹åˆè¯·å‡</div>
            <div class="guide-step">4. <strong>æŸ¥çœ‹ç»Ÿè®¡</strong>ï¼šé€‰æ‹©æœˆä»½æŸ¥çœ‹å·¥ä½œç»Ÿè®¡</div>
            <div class="guide-step">5. <strong>å¯¼å‡ºæ•°æ®</strong>ï¼šç‚¹å‡»å¯¼å‡ºæŒ‰é’®ç”ŸæˆExcelæŠ¥è¡¨</div>
            <div class="guide-step">6. <strong>ä¿®æ”¹è®°å½•</strong>ï¼šç‚¹å‡»è®°å½•ä¸­çš„ä¿®æ”¹æŒ‰é’®ç¼–è¾‘å·²æœ‰è®°å½•</div>
            <div class="guide-step">7. <strong>è‡ªå®šä¹‰å‘¨æœŸ</strong>ï¼šè®¾ç½®ç»Ÿè®¡å‘¨æœŸå¼€å§‹æ—¥ï¼Œå¦‚25å·åˆ°ä¸‹æœˆ25å·</div>
            <div class="guide-step">8. <strong>è¡¥å¡åŠŸèƒ½</strong>ï¼šæ‰¹é‡é€‰æ‹©æœªæ‰“å¡æ—¥æœŸè¿›è¡Œè¡¥å¡</div>
            <div class="guide-step">9. <strong>æ•°æ®å®‰å…¨</strong>ï¼šç³»ç»Ÿä½¿ç”¨å¤šé‡å¤‡ä»½æœºåˆ¶ï¼Œæ•°æ®æ›´å®‰å…¨</div>
        </div>

        <h1>ğŸ“Š å·¥ä½œæ—¶é—´ä¸åŠ ç­ç»Ÿè®¡ç³»ç»Ÿ</h1>
        
        <!-- æœˆä»½é€‰æ‹©å™¨ -->
        <div class="month-selector">
            <div class="settings-title">ğŸ“… æœˆä»½é€‰æ‹©</div>
            <div class="input-group">
                <label for="statMonth">é€‰æ‹©ç»Ÿè®¡æœˆä»½ï¼š</label>
                <input type="month" id="statMonth" value="">
                <button onclick="updateSelectedMonthStats()">æ›´æ–°ç»Ÿè®¡</button>
            </div>
            <div class="period-info" id="selectedMonthInfo">
                å½“å‰æ˜¾ç¤ºï¼šæœ¬æœˆç»Ÿè®¡æ•°æ®
            </div>
        </div>
        
        <!-- æ‰€æœ‰åŠŸèƒ½æ•´åˆåŒºåŸŸ -->
        <div class="all-functions-section">
            <div class="settings-title" onclick="toggleAllFunctions()">
                <span>âš™ï¸ æ‰€æœ‰åŠŸèƒ½è®¾ç½®</span>
                <span id="allFunctionsToggle">â–¼</span>
            </div>
            <div class="settings-content" id="allFunctionsContent" style="display: block;">
                <!-- ç»Ÿè®¡å‘¨æœŸè®¾ç½® -->
                <div class="function-group">
                    <div class="function-title" onclick="toggleFunction('periodSettings')">
                        <span>ğŸ“… ç»Ÿè®¡å‘¨æœŸè®¾ç½®</span>
                        <span id="periodSettingsToggle">â–¶</span>
                    </div>
                    <div class="function-content" id="periodSettingsContent" style="display: none;">
                        <div class="input-group">
                            <label for="periodStartDay">ç»Ÿè®¡å‘¨æœŸå¼€å§‹æ—¥ï¼š</label>
                            <select id="periodStartDay">
                                <option value="1">1å·</option>
                                <option value="2">2å·</option>
                                <option value="3">3å·</option>
                                <option value="4">4å·</option>
                                <option value="5">5å·</option>
                                <option value="6">6å·</option>
                                <option value="7">7å·</option>
                                <option value="8">8å·</option>
                                <option value="9">9å·</option>
                                <option value="10">10å·</option>
                                <option value="11">11å·</option>
                                <option value="12">12å·</option>
                                <option value="13">13å·</option>
                                <option value="14">14å·</option>
                                <option value="15">15å·</option>
                                <option value="16">16å·</option>
                                <option value="17">17å·</option>
                                <option value="18">18å·</option>
                                <option value="19">19å·</option>
                                <option value="20">20å·</option>
                                <option value="21">21å·</option>
                                <option value="22">22å·</option>
                                <option value="23">23å·</option>
                                <option value="24">24å·</option>
                                <option value="25" selected>25å·</option>
                                <option value="26">26å·</option>
                                <option value="27">27å·</option>
                                <option value="28">28å·</option>
                                <option value="29">29å·</option>
                                <option value="30">30å·</option>
                                <option value="31">31å·</option>
                            </select>
                            <button onclick="savePeriodSettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                        <div class="period-info" id="periodInfo">
                            å½“å‰ç»Ÿè®¡å‘¨æœŸï¼šä¸Šä¸ªæœˆ25å· - æœ¬æœˆ25å·
                        </div>
                    </div>
                </div>
                
                <!-- è¡¥å¡åŠŸèƒ½ -->
                <div class="function-group">
                    <div class="function-title" onclick="toggleFunction('supplementFunction')">
                        <span>ğŸ”„ è¡¥å¡åŠŸèƒ½</span>
                        <span id="supplementFunctionToggle">â–¶</span>
                    </div>
                    <div class="function-content" id="supplementFunctionContent" style="display: none;">
                        <div class="input-group">
                            <button class="supplement-btn" onclick="toggleSupplementMode()">å¼€å¯è¡¥å¡æ¨¡å¼</button>
                            <button class="supplement-btn" onclick="batchPunchCard()" id="batchPunchBtn" style="display: none;">æ‰¹é‡è¡¥å¡</button>
                            <button class="cancel-btn" onclick="cancelSupplementMode()" id="cancelSupplementBtn" style="display: none;">å–æ¶ˆè¡¥å¡</button>
                        </div>
                        <div class="selected-dates" id="selectedDates" style="display: none;">
                            <div>å·²é€‰æ‹©æ—¥æœŸï¼š</div>
                            <div id="selectedDatesList"></div>
                        </div>
                        <div class="supplement-calendar" id="supplementCalendar" style="display: none;">
                            <div class="calendar-header">
                                <div class="calendar-title" id="supplementCalendarTitle">2023å¹´12æœˆ</div>
                                <div class="calendar-nav">
                                    <button onclick="changeSupplementMonth(-1)">ä¸Šä¸ªæœˆ</button>
                                    <button onclick="changeSupplementMonth(1)">ä¸‹ä¸ªæœˆ</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="supplementCalendarGrid">
                                <!-- è¡¥å¡æ—¥å†ç”±JavaScriptç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®å¤‡ä»½ä¸æ¢å¤ -->
                <div class="function-group">
                    <div class="function-title" onclick="toggleFunction('backupFunction')">
                        <span>ğŸ’¾ æ•°æ®å¤‡ä»½ä¸æ¢å¤</span>
                        <span id="backupFunctionToggle">â–¶</span>
                    </div>
                    <div class="function-content" id="backupFunctionContent" style="display: none;">
                        <div class="backup-options">
                            <button onclick="exportBackup()">å¯¼å‡ºæ•°æ®å¤‡ä»½</button>
                            <button onclick="importBackup()">å¯¼å…¥æ•°æ®å¤‡ä»½</button>
                            <button onclick="createAutoBackup()">ç«‹å³åˆ›å»ºå¤‡ä»½</button>
                            <button onclick="clearAllData()" style="background: #e74c3c;">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                        </div>
                        <div class="backup-info">
                            <p><strong>å¤šé‡å¤‡ä»½æœºåˆ¶ï¼š</strong>æ•°æ®åŒæ—¶ä¿å­˜åœ¨ localStorageã€sessionStorageã€IndexedDB å’Œ Cookie ä¸­</p>
                            <p><strong>è‡ªåŠ¨å¤‡ä»½ï¼š</strong>ç³»ç»Ÿæ¯24å°æ—¶è‡ªåŠ¨å¤‡ä»½ä¸€æ¬¡ï¼Œé¡µé¢å…³é—­å‰ä¹Ÿä¼šå¤‡ä»½</p>
                            <p><strong>æ•°æ®æ¢å¤ï¼š</strong>æ£€æµ‹åˆ°æ•°æ®ä¸¢å¤±æ—¶è‡ªåŠ¨ä»å¤‡ä»½æ¢å¤</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="stats-section">
                <h2 id="statsTitle">æœ¬æœˆç»Ÿè®¡æ±‡æ€»</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div>å·¥ä½œå¤©æ•°</div>
                        <div class="stat-value" id="totalWorkDays">0 å¤©</div>
                    </div>
                    <div class="stat-item">
                        <div>è¯·å‡æ—¶é—´</div>
                        <div class="stat-value" id="totalLeaveHours">0 å°æ—¶</div>
                    </div>
                    <div class="stat-item">
                        <div>ä¼‘æ¯å¤©æ•°</div>
                        <div class="stat-value" id="totalRestDays">0 å¤©</div>
                    </div>
                    <div class="stat-item">
                        <div>åŠ ç­æ—¶é—´</div>
                        <div class="stat-value" id="totalOvertimeHours">0 å°æ—¶</div>
                    </div>
                </div>
                
                <!-- æ‰“å¡åŒºåŸŸ -->
                <div class="punch-section">
                    <button class="punch-btn" onclick="punchCard()">ğŸš€ ä¸€é”®æ‰“å¡</button>
                    <div class="punch-time" id="lastPunchTime">ä»Šæ—¥å°šæœªæ‰“å¡</div>
                </div>
            </div>
            
            <div class="calendar-section">
                <div class="calendar-header">
                    <div class="calendar-title" id="calendarTitle">2023å¹´12æœˆ</div>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)">ä¸Šä¸ªæœˆ</button>
                        <button onclick="changeMonth(1)">ä¸‹ä¸ªæœˆ</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- æ—¥å†ç”±JavaScriptç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <input type="date" id="dateInput" value="">
                <select id="dayType" onchange="toggleTimeInputs()">
                    <option value="work">å·¥ä½œæ—¥</option>
                    <option value="rest">ä¼‘æ¯æ—¥</option>
                    <option value="leave">è¯·å‡</option>
                </select>
                <button id="saveButton" onclick="addRecord()">ä¿å­˜è®°å½•</button>
                <button id="updateButton" class="update-btn" onclick="updateRecord()" style="display: none;">æ›´æ–°è®°å½•</button>
                <button id="cancelButton" class="cancel-btn" onclick="cancelEdit()" style="display: none;">å–æ¶ˆä¿®æ”¹</button>
            </div>
            
            <div id="timeInputs">
                <!-- è¯·å‡é€‰é¡¹ -->
                <div id="leaveSection" class="time-section" style="display: none;">
                    <div class="time-section-title">è¯·å‡ç±»å‹</div>
                    <div class="leave-options">
                        <label class="leave-option">
                            <input type="radio" name="leaveType" value="all" checked>
                            <span>å…¨å¤©è¯·å‡</span>
                        </label>
                        <label class="leave-option">
                            <input type="radio" name="leaveType" value="morning">
                            <span>ä¸Šåˆè¯·å‡</span>
                        </label>
                        <label class="leave-option">
                            <input type="radio" name="leaveType" value="afternoon">
                            <span>ä¸‹åˆè¯·å‡</span>
                        </label>
                    </div>
                </div>
                
                <!-- å·¥ä½œæ—¶é—´é€‰é¡¹ - å¯å±•å¼€æ”¶ç¼© -->
                <div class="time-section" id="workTimeSection">
                    <div class="time-section-title" onclick="toggleWorkTime()">
                        <span>å·¥ä½œæ—¶é—´è®¾ç½®</span>
                        <span id="workTimeToggle">â–¼</span>
                    </div>
                    <div class="time-section-content" id="workTimeContent" style="display: block;">
                        <!-- ä¸Šåˆå·¥ä½œæ—¶é—´ -->
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="morningWorkCheck" checked onchange="toggleMorningWork()">
                                <span>ä¸Šåˆä¸Šç­</span>
                            </label>
                        </div>
                        
                        <div id="morningWorkGroup">
                            <div class="time-group">
                                <span>ä¸Šç­:</span>
                                <select id="morningStart">
                                    <option value="08:00">08:00</option>
                                    <option value="08:30">08:30</option>
                                    <option value="09:00">09:00</option>
                                </select>
                                <span>ä¸‹ç­:</span>
                                <select id="morningEnd">
                                    <option value="12:00" selected>12:00</option>
                                    <option value="12:30">12:30</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ä¸‹åˆå·¥ä½œæ—¶é—´ -->
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="afternoonWorkCheck" checked onchange="toggleAfternoonWork()">
                                <span>ä¸‹åˆä¸Šç­</span>
                            </label>
                        </div>
                        
                        <div id="afternoonWorkGroup">
                            <div class="time-group">
                                <span>ä¸Šç­:</span>
                                <select id="afternoonStart">
                                    <option value="13:30" selected>13:30</option>
                                    <option value="14:00">14:00</option>
                                </select>
                                <span>ä¸‹ç­:</span>
                                <select id="afternoonEnd">
                                    <option value="17:00">17:00</option>
                                    <option value="17:30" selected>17:30</option>
                                    <option value="18:00">18:00</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ™šä¸ŠåŠ ç­ -->
                <div class="time-section" id="overtimeSection">
                    <div class="time-section-title" onclick="toggleOvertimeSection()">
                        <span>æ™šä¸ŠåŠ ç­</span>
                        <span id="overtimeToggle">â–¼</span>
                    </div>
                    <div class="time-section-content" id="overtimeContent" style="display: block;">
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="overtimeCheck" onchange="toggleOvertime()">
                                <span>æ™šä¸ŠåŠ ç­</span>
                            </label>
                        </div>
                        
                        <div id="overtimeGroup" style="display: none;">
                            <div class="time-group">
                                <span>å¼€å§‹:</span>
                                <select id="overtimeStart">
                                    <option value="18:30">18:30</option>
                                    <option value="19:00">19:00</option>
                                    <option value="19:30">19:30</option>
                                    <option value="20:00">20:00</option>
                                </select>
                                <span>ç»“æŸ:</span>
                                <select id="overtimeEnd">
                                    <option value="20:00">20:00</option>
                                    <option value="20:30">20:30</option>
                                    <option value="21:00">21:00</option>
                                    <option value="21:30" selected>21:30</option>
                                    <option value="22:00">22:00</option>
                                    <option value="22:30">22:30</option>
                                    <option value="23:00">23:00</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <button class="export-btn" onclick="exportToExcel()">ğŸ“Š å¯¼å‡ºExcelè¡¨æ ¼</button>
            </div>
        </div>
        
        <div class="records-section">
            <div class="sort-options">
                <h3>è®°å½•åˆ—è¡¨</h3>
                <div>
                    <label for="sortOrder">æ’åºæ–¹å¼ï¼š</label>
                    <select id="sortOrder" onchange="displayRecords()">
                        <option value="desc">æ—¥æœŸé™åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰</option>
                        <option value="asc">æ—¥æœŸå‡åºï¼ˆæœ€æ—©åœ¨å‰ï¼‰</option>
                    </select>
                </div>
            </div>
            
            <!-- æ•°æ®çŠ¶æ€æ˜¾ç¤º -->
            <div id="dataStatus" class="data-status">
                <!-- æ•°æ®çŠ¶æ€ä¿¡æ¯ç”±JavaScriptç”Ÿæˆ -->
            </div>
            
            <div id="recordsList">
                <!-- è®°å½•åˆ—è¡¨ç”±JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†ï¼Œç”¨äºå¯¼å…¥å¤‡ä»½ -->
    <input type="file" id="backupFileInput" accept=".json" style="display: none;">
    
    <script>
        let currentCalendarDate = new Date();
        let currentEditingId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„è®°å½•ID
        let isSupplementMode = false; // æ˜¯å¦å¤„äºè¡¥å¡æ¨¡å¼
        let selectedDates = []; // é€‰æ‹©çš„è¡¥å¡æ—¥æœŸ
        let currentSupplementMonth = new Date(); // è¡¥å¡æ—¥å†å½“å‰æœˆä»½
        let selectedMonth = null; // å½“å‰é€‰æ‹©çš„ç»Ÿè®¡æœˆä»½
        
        // IndexedDB æ•°æ®åº“å˜é‡
        let db = null;
        const DB_NAME = 'WorkTimeDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'workRecords';
        
        // è‡ªåŠ¨å¤‡ä»½è®¾ç½®
        const AUTO_BACKUP_INTERVAL = 24 * 60 * 60 * 1000; // 24å°æ—¶
        let lastBackupTime = 0;
        let backupIntervalId = null;

        // ==================== å¢å¼ºæ•°æ®å­˜å‚¨åŠŸèƒ½ ====================

        // å¢å¼ºçš„å­˜å‚¨å‡½æ•° - ä½¿ç”¨å¤šç§å­˜å‚¨æ–¹å¼
        function enhancedSetItem(key, value) {
            try {
                // 1. ä¸»è¦å­˜å‚¨ - localStorage
                localStorage.setItem(key, JSON.stringify(value));
                
                // 2. å¤‡ç”¨å­˜å‚¨ - sessionStorage
                sessionStorage.setItem(key, JSON.stringify(value));
                
                // 3. IndexedDB å­˜å‚¨
                saveToIndexedDB(key, value);
                
                // 4. Cookie å­˜å‚¨ (ç”¨äºå…³é”®è®¾ç½®)
                if (key.includes('Settings') || key.includes('UserId')) {
                    setCookie(key, JSON.stringify(value), 365);
                }
                
                console.log(`æ•°æ®å·²ä¿å­˜åˆ°å¤šé‡å­˜å‚¨: ${key}`);
                return true;
            } catch (error) {
                console.error('å­˜å‚¨å¤±è´¥:', error);
                return false;
            }
        }

        // å¢å¼ºçš„è¯»å–å‡½æ•°
        function enhancedGetItem(key) {
            let data = null;
            
            // 1. å°è¯•ä» localStorage è¯»å–
            try {
                const stored = localStorage.getItem(key);
                if (stored) {
                    data = JSON.parse(stored);
                    console.log(`ä» localStorage è¯»å–: ${key}`);
                    return data;
                }
            } catch (e) {
                console.warn(`localStorage è¯»å–å¤±è´¥: ${key}`, e);
            }
            
            // 2. å°è¯•ä» sessionStorage è¯»å–
            try {
                const stored = sessionStorage.getItem(key);
                if (stored) {
                    data = JSON.parse(stored);
                    console.log(`ä» sessionStorage è¯»å–: ${key}`);
                    // å°è¯•æ¢å¤å› localStorage
                    enhancedSetItem(key, data);
                    return data;
                }
            } catch (e) {
                console.warn(`sessionStorage è¯»å–å¤±è´¥: ${key}`, e);
            }
            
            // 3. å°è¯•ä» IndexedDB è¯»å–
            try {
                // æ³¨æ„ï¼šè¿™æ˜¯å¼‚æ­¥çš„ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬åŒæ­¥ç­‰å¾…
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const getRequest = store.get(key);
                    
                    getRequest.onsuccess = function() {
                        if (getRequest.result) {
                            data = getRequest.result.value;
                            console.log(`ä» IndexedDB è¯»å–: ${key}`);
                            enhancedSetItem(key, data); // æ¢å¤å›å…¶ä»–å­˜å‚¨
                        }
                    };
                };
            } catch (e) {
                console.warn(`IndexedDB è¯»å–å¤±è´¥: ${key}`, e);
            }
            
            // 4. å°è¯•ä» Cookie è¯»å–
            try {
                const cookieData = getCookie(key);
                if (cookieData) {
                    data = JSON.parse(cookieData);
                    console.log(`ä» Cookie è¯»å–: ${key}`);
                    enhancedSetItem(key, data); // æ¢å¤å›å…¶ä»–å­˜å‚¨
                    return data;
                }
            } catch (e) {
                console.warn(`Cookie è¯»å–å¤±è´¥: ${key}`, e);
            }
            
            return null;
        }

        // Cookie æ“ä½œå‡½æ•°
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        // IndexedDB æ•°æ®åº“æ“ä½œ
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });
                        console.log('IndexedDB å­˜å‚¨åˆ›å»ºæˆåŠŸ');
                    }
                };
            });
        }

        // ä¿å­˜åˆ° IndexedDB
        function saveToIndexedDB(key, value) {
            if (!db) {
                initIndexedDB().then(() => saveToIndexedDB(key, value));
                return;
            }
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.put({ key, value, timestamp: Date.now() });
            
            request.onerror = (event) => console.error('IndexedDB ä¿å­˜å¤±è´¥:', event.target.error);
        }

        // ==================== è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½ ====================

        // åˆå§‹åŒ–è‡ªåŠ¨å¤‡ä»½
        function initAutoBackup() {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½
            lastBackupTime = enhancedGetItem('lastBackupTime') || 0;
            const now = Date.now();
            
            if (now - lastBackupTime > AUTO_BACKUP_INTERVAL) {
                createAutoBackup();
            }
            
            // è®¾ç½®å®šæ—¶å¤‡ä»½
            backupIntervalId = setInterval(createAutoBackup, AUTO_BACKUP_INTERVAL);
            
            // ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶è¿›è¡Œæœ€åå¤‡ä»½
            window.addEventListener('beforeunload', function() {
                createAutoBackup();
            });
        }

        // åˆ›å»ºè‡ªåŠ¨å¤‡ä»½
        function createAutoBackup() {
            try {
                const backupData = {
                    records: getRecords(),
                    periodSettings: getPeriodSettings(),
                    userId: getUserId(),
                    backupDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                // ä¿å­˜åˆ°å¤šç§å­˜å‚¨
                enhancedSetItem('autoBackup', backupData);
                lastBackupTime = Date.now();
                enhancedSetItem('lastBackupTime', lastBackupTime);
                
                console.log('è‡ªåŠ¨å¤‡ä»½å®Œæˆ:', new Date().toLocaleString());
                showDataStatus(); // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            } catch (error) {
                console.error('è‡ªåŠ¨å¤‡ä»½å¤±è´¥:', error);
            }
        }

        // è‡ªåŠ¨æ¢å¤åŠŸèƒ½
        function autoRecoverData() {
            try {
                const backupData = enhancedGetItem('autoBackup');
                if (!backupData) return false;
                
                // æ£€æŸ¥å¤‡ä»½æ˜¯å¦è¾ƒæ–°ï¼ˆ7å¤©å†…ï¼‰
                const backupDate = new Date(backupData.backupDate);
                const now = new Date();
                const diffTime = Math.abs(now - backupDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 7) {
                    console.log('å¤‡ä»½æ•°æ®å·²è¿‡æœŸï¼Œè·³è¿‡æ¢å¤');
                    return false;
                }
                
                // æ£€æŸ¥å½“å‰æ•°æ®æ˜¯å¦ä¸ºç©ºæˆ–è¾ƒæ—§
                const currentRecords = getRecords();
                if (currentRecords.length === 0) {
                    // æ¢å¤æ•°æ®
                    enhancedSetItem(getStorageKey(), backupData.records);
                    enhancedSetItem('periodSettings_' + getUserId(), backupData.periodSettings);
                    console.log('æ•°æ®è‡ªåŠ¨æ¢å¤å®Œæˆ');
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('è‡ªåŠ¨æ¢å¤å¤±è´¥:', error);
                return false;
            }
        }

        // ==================== åŸæœ‰åŠŸèƒ½ï¼ˆä¿®æ”¹ä¸ºä½¿ç”¨å¢å¼ºå­˜å‚¨ï¼‰ ====================

        // ä¸ºä¸åŒç”¨æˆ·ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
        function getUserId() {
            let userId = enhancedGetItem('workRecordUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                enhancedSetItem('workRecordUserId', userId);
            }
            return userId;
        }

        // ä¿®æ”¹æ•°æ®å­˜å‚¨é”®åï¼ŒåŠ å…¥ç”¨æˆ·ID
        function getStorageKey() {
            return 'workRecords_' + getUserId();
        }
        
        // è·å–ç»Ÿè®¡å‘¨æœŸè®¾ç½®
        function getPeriodSettings() {
            const stored = enhancedGetItem('periodSettings_' + getUserId());
            return stored ? stored : { startDay: 25 };
        }
        
        // ä¿å­˜ç»Ÿè®¡å‘¨æœŸè®¾ç½®
        function savePeriodSettings() {
            const startDay = parseInt(document.getElementById('periodStartDay').value);
            const settings = { startDay };
            enhancedSetItem('periodSettings_' + getUserId(), settings);
            updatePeriodInfo();
            updateStatistics();
            renderCalendar();
            alert('ç»Ÿè®¡å‘¨æœŸè®¾ç½®å·²ä¿å­˜ï¼');
        }
        
        // æ›´æ–°ç»Ÿè®¡å‘¨æœŸä¿¡æ¯æ˜¾ç¤º
        function updatePeriodInfo() {
            const settings = getPeriodSettings();
            const startDay = settings.startDay;
            const periodRange = getCurrentPeriodRange();
            
            const startDate = `${periodRange.start.getFullYear()}-${periodRange.start.getMonth()+1}-${periodRange.start.getDate()}`;
            const endDate = `${periodRange.end.getFullYear()}-${periodRange.end.getMonth()+1}-${periodRange.end.getDate()}`;
            
            document.getElementById('periodInfo').textContent = 
                `å½“å‰ç»Ÿè®¡å‘¨æœŸï¼š${startDate} - ${endDate}`;
        }
        
        // è·å–å½“å‰ç»Ÿè®¡å‘¨æœŸçš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ
        function getCurrentPeriodRange() {
            const settings = getPeriodSettings();
            const startDay = settings.startDay;
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const currentDate = today.getDate();
            
            // å½“å‰å‘¨æœŸçš„å¼€å§‹æ—¥æœŸ
            let periodStart, periodEnd;
            
            if (currentDate >= startDay) {
                // å¦‚æœä»Šå¤©å¤§äºç­‰äºå¼€å§‹æ—¥ï¼Œåˆ™å‘¨æœŸæ˜¯æœ¬æœˆå¼€å§‹æ—¥åˆ°ä¸‹æœˆå¼€å§‹æ—¥
                periodStart = new Date(currentYear, currentMonth, startDay);
                periodEnd = new Date(currentYear, currentMonth + 1, startDay);
                // å°†ç»“æŸæ—¥æœŸè®¾ç½®ä¸ºå½“å¤©çš„23:59:59ï¼ŒåŒ…å«å½“å¤©
                periodEnd.setHours(23, 59, 59, 999);
            } else {
                // å¦‚æœä»Šå¤©å°äºå¼€å§‹æ—¥ï¼Œåˆ™å‘¨æœŸæ˜¯ä¸Šæœˆå¼€å§‹æ—¥åˆ°æœ¬æœˆå¼€å§‹æ—¥
                periodStart = new Date(currentYear, currentMonth - 1, startDay);
                periodEnd = new Date(currentYear, currentMonth, startDay);
                // å°†ç»“æŸæ—¥æœŸè®¾ç½®ä¸ºå½“å¤©çš„23:59:59ï¼ŒåŒ…å«å½“å¤©
                periodEnd.setHours(23, 59, 59, 999);
            }
            
            return {
                start: periodStart,
                end: periodEnd
            };
        }
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            updateOvertimeCheckbox(); // åˆå§‹åŒ–æ—¶æ ¹æ®ä»Šå¤©æ—¥æœŸè®¾ç½®åŠ ç­å¤é€‰æ¡†
        }

        // è·å–æ˜ŸæœŸå‡  (0:å‘¨æ—¥, 1:å‘¨ä¸€, ..., 6:å‘¨å…­)
        function getDayOfWeek(dateStr) {
            const date = new Date(dateStr);
            return date.getDay();
        }

        // è·å–æ˜ŸæœŸå‡ çš„ä¸­æ–‡åç§°
        function getWeekdayName(dateStr) {
            const day = getDayOfWeek(dateStr);
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            return weekdays[day];
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«
        function isWeekend(dateStr) {
            const day = getDayOfWeek(dateStr);
            return day === 0 || day === 6; // 0:å‘¨æ—¥, 6:å‘¨å…­
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æ—¥
        function isSunday(dateStr) {
            return getDayOfWeek(dateStr) === 0;
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨å…­
        function isSaturday(dateStr) {
            return getDayOfWeek(dateStr) === 6;
        }

        // æ ¹æ®æ—¥æœŸæ›´æ–°åŠ ç­å¤é€‰æ¡†çŠ¶æ€
        function updateOvertimeCheckbox() {
            const dateInput = document.getElementById('dateInput').value;
            const isWeekendDate = isWeekend(dateInput);
            document.getElementById('overtimeCheck').checked = !isWeekendDate;
            toggleOvertime();
        }

        // åˆ‡æ¢è¡¥å¡æ¨¡å¼
        function toggleSupplementMode() {
            isSupplementMode = true;
            selectedDates = [];
            
            // æ˜¾ç¤ºè¡¥å¡ç›¸å…³å…ƒç´ 
            document.getElementById('batchPunchBtn').style.display = 'inline-block';
            document.getElementById('cancelSupplementBtn').style.display = 'inline-block';
            document.getElementById('supplementCalendar').style.display = 'block';
            document.getElementById('selectedDates').style.display = 'block';
            
            // æ›´æ–°é€‰æ‹©æ—¥æœŸåˆ—è¡¨
            updateSelectedDatesList();
            
            // æ¸²æŸ“è¡¥å¡æ—¥å†
            renderSupplementCalendar();
            
            alert('å·²è¿›å…¥è¡¥å¡æ¨¡å¼ï¼Œè¯·é€‰æ‹©éœ€è¦è¡¥å¡çš„æ—¥æœŸ');
        }

        // å–æ¶ˆè¡¥å¡æ¨¡å¼
        function cancelSupplementMode() {
            isSupplementMode = false;
            selectedDates = [];
            
            // éšè—è¡¥å¡ç›¸å…³å…ƒç´ 
            document.getElementById('batchPunchBtn').style.display = 'none';
            document.getElementById('cancelSupplementBtn').style.display = 'none';
            document.getElementById('supplementCalendar').style.display = 'none';
            document.getElementById('selectedDates').style.display = 'none';
            
            // é‡æ–°æ¸²æŸ“ä¸»æ—¥å†
            renderCalendar();
        }

        // æ›´æ–°é€‰æ‹©æ—¥æœŸåˆ—è¡¨
        function updateSelectedDatesList() {
            const selectedDatesList = document.getElementById('selectedDatesList');
            selectedDatesList.innerHTML = '';
            
            if (selectedDates.length === 0) {
                selectedDatesList.innerHTML = '<div style="color: #7f8c8d; font-style: italic;">æš‚æ— é€‰æ‹©æ—¥æœŸ</div>';
                return;
            }
            
            // æ’åºæ—¥æœŸ
            selectedDates.sort((a, b) => new Date(a) - new Date(b));
            
            selectedDates.forEach(date => {
                const dateItem = document.createElement('div');
                dateItem.className = 'selected-date-item';
                dateItem.textContent = date;
                selectedDatesList.appendChild(dateItem);
            });
        }

        // æ¸²æŸ“è¡¥å¡æ—¥å†
        function renderSupplementCalendar() {
            const calendarGrid = document.getElementById('supplementCalendarGrid');
            const calendarTitle = document.getElementById('supplementCalendarTitle');
            
            const year = currentSupplementMonth.getFullYear();
            const month = currentSupplementMonth.getMonth();
            
            // è®¾ç½®æ—¥å†æ ‡é¢˜
            calendarTitle.textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0æ˜¯å‘¨æ—¥ï¼Œ6æ˜¯å‘¨å…­ï¼‰
            const firstDayOfWeek = firstDay.getDay();
            
            // è·å–ä¸Šä¸ªæœˆçš„æœ€åå‡ å¤©
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            // æ¸…ç©ºæ—¥å†
            calendarGrid.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-weekday';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            });
            
            // æ·»åŠ ä¸Šä¸ªæœˆçš„æ—¥æœŸ
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `
                    <div class="day-number">${prevMonthLastDay - i}</div>
                `;
                calendarGrid.appendChild(dayElement);
            }
            
            // æ·»åŠ å½“æœˆçš„æ—¥æœŸ
            const records = getRecords();
            const today = new Date();
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const record = records.find(r => r.date === dateStr);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
                if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === day) {
                    dayElement.classList.add('today');
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
                if (selectedDates.includes(dateStr)) {
                    dayElement.classList.add('selected-day');
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å½“å‰ç»Ÿè®¡å‘¨æœŸå†…
                if (isDateInCurrentPeriod(dateStr)) {
                    dayElement.classList.add('period-day');
                }
                
                let statusText = '';
                let statusClass = '';
                
                if (record) {
                    if (record.dayType === 'work') {
                        statusText = 'å·¥ä½œ';
                        statusClass = 'work-status';
                    } else if (record.dayType === 'leave') {
                        statusText = record.leaveType === 'all' ? 'å…¨å¤©å‡' : 
                                   record.leaveType === 'morning' ? 'ä¸Šåˆå‡' : 'ä¸‹åˆå‡';
                        statusClass = 'leave-status';
                    } else if (record.dayType === 'rest') {
                        statusText = 'ä¼‘æ¯';
                        statusClass = 'rest-status';
                    }
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${statusText ? `<div class="day-status ${statusClass}">${statusText}</div>` : ''}
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - é€‰æ‹©/å–æ¶ˆé€‰æ‹©æ—¥æœŸ
                dayElement.onclick = () => {
                    if (!isSupplementMode) return;
                    
                    if (selectedDates.includes(dateStr)) {
                        // å¦‚æœå·²é€‰æ‹©ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                        selectedDates = selectedDates.filter(d => d !== dateStr);
                        dayElement.classList.remove('selected-day');
                    } else {
                        // å¦‚æœæœªé€‰æ‹©ï¼Œåˆ™æ·»åŠ é€‰æ‹©
                        selectedDates.push(dateStr);
                        dayElement.classList.add('selected-day');
                    }
                    
                    updateSelectedDatesList();
                };
                
                calendarGrid.appendChild(dayElement);
            }
            
            // æ·»åŠ ä¸‹ä¸ªæœˆçš„æ—¥æœŸï¼ˆè¡¥é½å‰©ä½™æ ¼å­ï¼‰
            const totalCells = 42; // 6è¡Œ * 7åˆ—
            const remainingCells = totalCells - firstDayOfWeek - lastDay.getDate();
            
            for (let day = 1; day <= remainingCells; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                `;
                calendarGrid.appendChild(dayElement);
            }
        }

        // åˆ‡æ¢è¡¥å¡æ—¥å†æœˆä»½
        function changeSupplementMonth(direction) {
            currentSupplementMonth.setMonth(currentSupplementMonth.getMonth() + direction);
            renderSupplementCalendar();
        }

        // æ‰¹é‡è¡¥å¡
        function batchPunchCard() {
            if (selectedDates.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©éœ€è¦è¡¥å¡çš„æ—¥æœŸ');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦ä¸º ${selectedDates.length} ä¸ªæ—¥æœŸè¿›è¡Œè¡¥å¡å—ï¼Ÿ`)) {
                return;
            }
            
            const records = getRecords();
            let successCount = 0;
            let skipCount = 0;
            
            selectedDates.forEach(dateStr => {
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰è®°å½•
                const existingRecord = records.find(r => r.date === dateStr);
                if (existingRecord) {
                    skipCount++;
                    return;
                }
                
                // æ ¹æ®æ˜ŸæœŸå‡ è®¾ç½®ä¸åŒçš„å·¥ä½œæ—¶é—´
                const dayOfWeek = getDayOfWeek(dateStr);
                let record = {
                    id: Date.now() + Math.random(), // ç¡®ä¿IDå”¯ä¸€
                    date: dateStr,
                    dayType: 'work',
                    morningWork: null,
                    afternoonWork: null,
                    overtime: null,
                    leaveType: null,
                    normalDuration: 0,
                    overtimeDuration: 0
                };

                // ä¸Šåˆå·¥ä½œæ—¶é—´ (8:00-12:00)
                record.morningWork = {
                    start: '08:00',
                    end: '12:00',
                    duration: calculateDuration('08:00', '12:00')
                };

                // ä¸‹åˆå·¥ä½œæ—¶é—´ (13:30-17:30)
                record.afternoonWork = {
                    start: '13:30',
                    end: '17:30',
                    duration: calculateDuration('13:30', '17:30')
                };

                // æ ¹æ®æ˜ŸæœŸå‡ è®¾ç½®åŠ ç­æ—¶é—´
                if (dayOfWeek === 6) { // å‘¨å…­
                    // å‘¨å…­ä¸ç”¨åŠ ç­
                    record.overtime = null;
                } else if (dayOfWeek === 0) { // å‘¨æ—¥
                    // å‘¨æ—¥å…¨å¤©å·¥ä½œéƒ½ç®—åŠ ç­ï¼Œæ‰€ä»¥ä¸è®°å½•å•ç‹¬çš„åŠ ç­æ—¶é—´æ®µ
                    record.overtime = null;
                } else { // å‘¨ä¸€è‡³å‘¨äº”
                    // æ™šä¸ŠåŠ ç­æ—¶é—´ (18:30-21:30)
                    record.overtime = {
                        start: '18:30',
                        end: '21:30',
                        duration: calculateDuration('18:30', '21:30')
                    };
                }

                // è®¡ç®—æ­£å¸¸å·¥ä½œæ—¶é•¿å’ŒåŠ ç­æ—¶é•¿
                calculateWorkTime(record);
                
                // ä¿å­˜è®°å½•
                records.push(record);
                successCount++;
            });
            
            enhancedSetItem(getStorageKey(), records);
            
            // åˆ·æ–°æ˜¾ç¤º
            displayRecords();
            updateStatistics();
            renderCalendar();
            renderSupplementCalendar();
            
            // æ˜¾ç¤ºç»“æœ
            let message = `è¡¥å¡å®Œæˆï¼æˆåŠŸè¡¥å¡ ${successCount} ä¸ªæ—¥æœŸ`;
            if (skipCount > 0) {
                message += `ï¼Œè·³è¿‡ ${skipCount} ä¸ªå·²æœ‰è®°å½•çš„æ—¥æœŸ`;
            }
            alert(message);
            
            // é‡ç½®é€‰æ‹©
            selectedDates = [];
            updateSelectedDatesList();
        }

        // åˆ‡æ¢æ—¶é—´è¾“å…¥æ¡†æ˜¾ç¤º
        function toggleTimeInputs() {
            const dayType = document.getElementById('dayType').value;
            const timeInputs = document.getElementById('timeInputs');
            const leaveSection = document.getElementById('leaveSection');
            const workTimeSection = document.getElementById('workTimeSection');
            const overtimeSection = document.getElementById('overtimeSection');
            
            if (dayType === 'rest') {
                timeInputs.style.display = 'none';
            } else if (dayType === 'leave') {
                timeInputs.style.display = 'block';
                leaveSection.style.display = 'block';
                workTimeSection.style.display = 'block';
                overtimeSection.style.display = 'block';
            } else {
                timeInputs.style.display = 'block';
                leaveSection.style.display = 'none';
                workTimeSection.style.display = 'block';
                overtimeSection.style.display = 'block';
            }
        }

        // åˆ‡æ¢å·¥ä½œæ—¶é—´åŒºåŸŸå±•å¼€/æ”¶ç¼©
        function toggleWorkTime() {
            const content = document.getElementById('workTimeContent');
            const toggle = document.getElementById('workTimeToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }

        // åˆ‡æ¢åŠ ç­æ—¶é—´åŒºåŸŸå±•å¼€/æ”¶ç¼©
        function toggleOvertimeSection() {
            const content = document.getElementById('overtimeContent');
            const toggle = document.getElementById('overtimeToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }

        // åˆ‡æ¢ä¸Šåˆå·¥ä½œæ—¶é—´
        function toggleMorningWork() {
            const checked = document.getElementById('morningWorkCheck').checked;
            document.getElementById('morningWorkGroup').style.display = checked ? 'block' : 'none';
        }

        // åˆ‡æ¢ä¸‹åˆå·¥ä½œæ—¶é—´
        function toggleAfternoonWork() {
            const checked = document.getElementById('afternoonWorkCheck').checked;
            document.getElementById('afternoonWorkGroup').style.display = checked ? 'block' : 'none';
        }

        // åˆ‡æ¢åŠ ç­æ—¶é—´
        function toggleOvertime() {
            const checked = document.getElementById('overtimeCheck').checked;
            document.getElementById('overtimeGroup').style.display = checked ? 'block' : 'none';
        }

        // è®¡ç®—å·¥ä½œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
        function calculateDuration(startTime, endTime) {
            const start = parseTime(startTime);
            const end = parseTime(endTime);
            return Math.max(0, end - start);
        }

        // è§£ææ—¶é—´å­—ç¬¦ä¸²ä¸ºåˆ†é’Ÿæ•°
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // æ ¼å¼åŒ–æ—¶é•¿ä¸ºå°æ—¶æ˜¾ç¤º
        function formatDuration(minutes) {
            return (minutes / 60).toFixed(1) + 'å°æ—¶';
        }

        // è·å–è¯·å‡ç±»å‹
        function getLeaveType() {
            const leaveType = document.querySelector('input[name="leaveType"]:checked').value;
            return leaveType;
        }

        // æ‰“å¡åŠŸèƒ½ - æ ¹æ®æ—¥æœŸè‡ªåŠ¨è°ƒæ•´å·¥ä½œæ—¶é—´
        function punchCard() {
            const today = new Date().toISOString().split('T')[0];
            const records = getRecords();
            
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æœ‰è®°å½•
            const existingRecord = records.find(r => r.date === today);
            if (existingRecord) {
                if (!confirm('ä»Šå¤©å·²æœ‰è®°å½•ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ')) {
                    return;
                }
            }
            
            // æ ¹æ®æ˜ŸæœŸå‡ è®¾ç½®ä¸åŒçš„å·¥ä½œæ—¶é—´
            const dayOfWeek = getDayOfWeek(today);
            let record = {
                id: Date.now(),
                date: today,
                dayType: 'work',
                morningWork: null,
                afternoonWork: null,
                overtime: null,
                leaveType: null,
                normalDuration: 0,
                overtimeDuration: 0
            };

            // ä¸Šåˆå·¥ä½œæ—¶é—´ (8:00-12:00)
            record.morningWork = {
                start: '08:00',
                end: '12:00',
                duration: calculateDuration('08:00', '12:00')
            };

            // ä¸‹åˆå·¥ä½œæ—¶é—´ (13:30-17:30)
            record.afternoonWork = {
                start: '13:30',
                end: '17:30',
                duration: calculateDuration('13:30', '17:30')
            };

            // æ ¹æ®æ˜ŸæœŸå‡ è®¾ç½®åŠ ç­æ—¶é—´
            if (dayOfWeek === 6) { // å‘¨å…­
                // å‘¨å…­ä¸ç”¨åŠ ç­
                record.overtime = null;
            } else if (dayOfWeek === 0) { // å‘¨æ—¥
                // å‘¨æ—¥å…¨å¤©å·¥ä½œéƒ½ç®—åŠ ç­ï¼Œæ‰€ä»¥ä¸è®°å½•å•ç‹¬çš„åŠ ç­æ—¶é—´æ®µ
                record.overtime = null;
            } else { // å‘¨ä¸€è‡³å‘¨äº”
                // æ™šä¸ŠåŠ ç­æ—¶é—´ (18:30-21:30)
                record.overtime = {
                    start: '18:30',
                    end: '21:30',
                    duration: calculateDuration('18:30', '21:30')
                };
            }

            // è®¡ç®—æ­£å¸¸å·¥ä½œæ—¶é•¿å’ŒåŠ ç­æ—¶é•¿
            calculateWorkTime(record);
            
            // ä¿å­˜è®°å½•
            const existingIndex = records.findIndex(r => r.date === today);
            if (existingIndex > -1) {
                records[existingIndex] = record;
            } else {
                records.push(record);
            }
            
            enhancedSetItem(getStorageKey(), records);
            
            // æ›´æ–°æœ€åæ‰“å¡æ—¶é—´
            const now = new Date();
            const punchTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            enhancedSetItem('lastPunchTime_' + getUserId(), punchTime);
            document.getElementById('lastPunchTime').textContent = `ä¸Šæ¬¡æ‰“å¡æ—¶é—´: ${punchTime}`;
            
            // åˆ·æ–°æ˜¾ç¤º
            displayRecords();
            updateStatistics();
            renderCalendar();
            
            let message = 'æ‰“å¡æˆåŠŸï¼';
            if (dayOfWeek === 6) {
                message += '\nä»Šå¤©æ˜¯å‘¨å…­ï¼Œå·²è®°å½•ä¸Šåˆå’Œä¸‹åˆå·¥ä½œæ—¶é—´ï¼Œæ™šä¸Šä¸åŠ ç­ã€‚';
            } else if (dayOfWeek === 0) {
                message += '\nä»Šå¤©æ˜¯å‘¨æ—¥ï¼Œå…¨å¤©å·¥ä½œæ—¶é—´è®¡å…¥åŠ ç­ã€‚';
            } else {
                message += '\nå·²è®°å½•å®Œæ•´å·¥ä½œæ—¥æ—¶é—´ï¼ˆå«æ™šä¸ŠåŠ ç­ï¼‰ã€‚';
            }
            alert(message);
        }

        // è®¡ç®—æ­£å¸¸å·¥ä½œæ—¶é•¿å’ŒåŠ ç­æ—¶é•¿
        function calculateWorkTime(record) {
            const dateStr = record.date;
            let normalDuration = 0;
            let overtimeDuration = 0;

            // æ­£å¸¸å·¥ä½œæ—¶é—´æ®µå®šä¹‰
            const normalWorkTimes = {
                morning: { start: '08:00', end: '12:00' },
                afternoon: { start: '13:30', end: '17:30' }
            };

            if (isSunday(dateStr)) {
                // å‘¨æ—¥ï¼šå…¨å¤©å·¥ä½œéƒ½ç®—åŠ ç­
                if (record.morningWork) overtimeDuration += record.morningWork.duration;
                if (record.afternoonWork) overtimeDuration += record.afternoonWork.duration;
                if (record.overtime) overtimeDuration += record.overtime.duration;
            } else if (isSaturday(dateStr)) {
                // å‘¨å…­ï¼šåªè®¡ç®—æ­£å¸¸å·¥ä½œæ—¶é—´ï¼Œæ²¡æœ‰åŠ ç­
                if (record.morningWork) {
                    const overlap = calculateOverlap(
                        record.morningWork.start, record.morningWork.end,
                        normalWorkTimes.morning.start, normalWorkTimes.morning.end
                    );
                    normalDuration += overlap;
                    overtimeDuration += (record.morningWork.duration - overlap);
                }
                if (record.afternoonWork) {
                    const overlap = calculateOverlap(
                        record.afternoonWork.start, record.afternoonWork.end,
                        normalWorkTimes.afternoon.start, normalWorkTimes.afternoon.end
                    );
                    normalDuration += overlap;
                    overtimeDuration += (record.afternoonWork.duration - overlap);
                }
                // å‘¨å…­æ²¡æœ‰æ™šä¸ŠåŠ ç­
            } else {
                // å‘¨ä¸€è‡³å‘¨äº”ï¼šæŒ‰æ­£å¸¸å·¥ä½œæ—¶é—´è®¡ç®—
                if (record.morningWork) {
                    const overlap = calculateOverlap(
                        record.morningWork.start, record.morningWork.end,
                        normalWorkTimes.morning.start, normalWorkTimes.morning.end
                    );
                    normalDuration += overlap;
                    overtimeDuration += (record.morningWork.duration - overlap);
                }
                if (record.afternoonWork) {
                    const overlap = calculateOverlap(
                        record.afternoonWork.start, record.afternoonWork.end,
                        normalWorkTimes.afternoon.start, normalWorkTimes.afternoon.end
                    );
                    normalDuration += overlap;
                    overtimeDuration += (record.afternoonWork.duration - overlap);
                }
                // æ™šä¸ŠåŠ ç­å…¨éƒ¨ç®—ä½œåŠ ç­
                if (record.overtime) {
                    overtimeDuration += record.overtime.duration;
                }
            }

            record.normalDuration = normalDuration;
            record.overtimeDuration = overtimeDuration;
            return record;
        }

        // è®¡ç®—ä¸¤ä¸ªæ—¶é—´æ®µçš„é‡å éƒ¨åˆ†
        function calculateOverlap(start1, end1, start2, end2) {
            const startMin1 = parseTime(start1);
            const endMin1 = parseTime(end1);
            const startMin2 = parseTime(start2);
            const endMin2 = parseTime(end2);
            
            const overlapStart = Math.max(startMin1, startMin2);
            const overlapEnd = Math.min(endMin1, endMin2);
            
            return Math.max(0, overlapEnd - overlapStart);
        }

        // æ›´æ–°æœ€åæ‰“å¡æ—¶é—´æ˜¾ç¤º
        function updateLastPunchTime() {
            const lastPunch = enhancedGetItem('lastPunchTime_' + getUserId());
            if (lastPunch) {
                document.getElementById('lastPunchTime').textContent = `ä¸Šæ¬¡æ‰“å¡æ—¶é—´: ${lastPunch}`;
            }
        }

        // æ·»åŠ è®°å½•
        function addRecord() {
            const date = document.getElementById('dateInput').value;
            const dayType = document.getElementById('dayType').value;
            
            if (!date) {
                alert('è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }

            let record = {
                id: Date.now(),
                date: date,
                dayType: dayType,
                morningWork: null,
                afternoonWork: null,
                overtime: null,
                leaveType: null,
                normalDuration: 0,
                overtimeDuration: 0
            };

            // ä¸Šåˆå·¥ä½œï¼ˆè¯·å‡æ—¶ä¹Ÿå¯ä»¥è®°å½•ï¼‰
            if (document.getElementById('morningWorkCheck').checked) {
                const morningStart = document.getElementById('morningStart').value;
                const morningEnd = document.getElementById('morningEnd').value;
                const morningDuration = calculateDuration(morningStart, morningEnd);
                
                record.morningWork = {
                    start: morningStart,
                    end: morningEnd,
                    duration: morningDuration
                };
            }

            // ä¸‹åˆå·¥ä½œï¼ˆè¯·å‡æ—¶ä¹Ÿå¯ä»¥è®°å½•ï¼‰
            if (document.getElementById('afternoonWorkCheck').checked) {
                const afternoonStart = document.getElementById('afternoonStart').value;
                const afternoonEnd = document.getElementById('afternoonEnd').value;
                const afternoonDuration = calculateDuration(afternoonStart, afternoonEnd);
                
                record.afternoonWork = {
                    start: afternoonStart,
                    end: afternoonEnd,
                    duration: afternoonDuration
                };
            }

            // åŠ ç­
            if (document.getElementById('overtimeCheck').checked) {
                const overtimeStart = document.getElementById('overtimeStart').value;
                const overtimeEnd = document.getElementById('overtimeEnd').value;
                const overtimeDuration = calculateDuration(overtimeStart, overtimeEnd);
                
                record.overtime = {
                    start: overtimeStart,
                    end: overtimeEnd,
                    duration: overtimeDuration
                };
            }

            // è¯·å‡ç±»å‹
            if (dayType === 'leave') {
                record.leaveType = getLeaveType();
                
                // æ ¹æ®è¯·å‡ç±»å‹è‡ªåŠ¨è°ƒæ•´å·¥ä½œæ—¶é—´æ®µ
                if (record.leaveType === 'morning') {
                    // ä¸Šåˆè¯·å‡ï¼Œè‡ªåŠ¨å–æ¶ˆä¸Šåˆå·¥ä½œ
                    record.morningWork = null;
                } else if (record.leaveType === 'afternoon') {
                    // ä¸‹åˆè¯·å‡ï¼Œè‡ªåŠ¨å–æ¶ˆä¸‹åˆå·¥ä½œ
                    record.afternoonWork = null;
                } else if (record.leaveType === 'all') {
                    // å…¨å¤©è¯·å‡ï¼Œå–æ¶ˆæ‰€æœ‰å·¥ä½œ
                    record.morningWork = null;
                    record.afternoonWork = null;
                    record.overtime = null;
                }
            }

            // æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå·¥ä½œæ—¶é—´æ®µï¼ˆé™¤äº†å…¨å¤©è¯·å‡ï¼‰
            if (dayType !== 'leave' || record.leaveType !== 'all') {
                if (!record.morningWork && !record.afternoonWork && !record.overtime) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå·¥ä½œæ—¶é—´æ®µ');
                    return;
                }
            }

            // è®¡ç®—æ­£å¸¸å·¥ä½œæ—¶é•¿å’ŒåŠ ç­æ—¶é•¿
            calculateWorkTime(record);

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const records = getRecords();
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒæ—¥æœŸçš„è®°å½•
            const existingIndex = records.findIndex(r => r.date === date);
            if (existingIndex > -1) {
                records[existingIndex] = record; // æ›´æ–°è®°å½•
            } else {
                records.push(record); // æ–°å¢è®°å½•
            }
            
            enhancedSetItem(getStorageKey(), records);
            
            // åˆ·æ–°æ˜¾ç¤º
            displayRecords();
            updateStatistics();
            renderCalendar();
            alert('è®°å½•ä¿å­˜æˆåŠŸï¼');
        }

        // æ›´æ–°è®°å½•
        function updateRecord() {
            if (!currentEditingId) {
                alert('æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„è®°å½•');
                return;
            }

            const date = document.getElementById('dateInput').value;
            const dayType = document.getElementById('dayType').value;
            
            if (!date) {
                alert('è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }

            let record = {
                id: currentEditingId,
                date: date,
                dayType: dayType,
                morningWork: null,
                afternoonWork: null,
                overtime: null,
                leaveType: null,
                normalDuration: 0,
                overtimeDuration: 0
            };

            // ä¸Šåˆå·¥ä½œï¼ˆè¯·å‡æ—¶ä¹Ÿå¯ä»¥è®°å½•ï¼‰
            if (document.getElementById('morningWorkCheck').checked) {
                const morningStart = document.getElementById('morningStart').value;
                const morningEnd = document.getElementById('morningEnd').value;
                const morningDuration = calculateDuration(morningStart, morningEnd);
                
                record.morningWork = {
                    start: morningStart,
                    end: morningEnd,
                    duration: morningDuration
                };
            }

            // ä¸‹åˆå·¥ä½œï¼ˆè¯·å‡æ—¶ä¹Ÿå¯ä»¥è®°å½•ï¼‰
            if (document.getElementById('afternoonWorkCheck').checked) {
                const afternoonStart = document.getElementById('afternoonStart').value;
                const afternoonEnd = document.getElementById('afternoonEnd').value;
                const afternoonDuration = calculateDuration(afternoonStart, afternoonEnd);
                
                record.afternoonWork = {
                    start: afternoonStart,
                    end: afternoonEnd,
                    duration: afternoonDuration
                };
            }

            // åŠ ç­
            if (document.getElementById('overtimeCheck').checked) {
                const overtimeStart = document.getElementById('overtimeStart').value;
                const overtimeEnd = document.getElementById('overtimeEnd').value;
                const overtimeDuration = calculateDuration(overtimeStart, overtimeEnd);
                
                record.overtime = {
                    start: overtimeStart,
                    end: overtimeEnd,
                    duration: overtimeDuration
                };
            }

            // è¯·å‡ç±»å‹
            if (dayType === 'leave') {
                record.leaveType = getLeaveType();
                
                // æ ¹æ®è¯·å‡ç±»å‹è‡ªåŠ¨è°ƒæ•´å·¥ä½œæ—¶é—´æ®µ
                if (record.leaveType === 'morning') {
                    // ä¸Šåˆè¯·å‡ï¼Œè‡ªåŠ¨å–æ¶ˆä¸Šåˆå·¥ä½œ
                    record.morningWork = null;
                } else if (record.leaveType === 'afternoon') {
                    // ä¸‹åˆè¯·å‡ï¼Œè‡ªåŠ¨å–æ¶ˆä¸‹åˆå·¥ä½œ
                    record.afternoonWork = null;
                } else if (record.leaveType === 'all') {
                    // å…¨å¤©è¯·å‡ï¼Œå–æ¶ˆæ‰€æœ‰å·¥ä½œ
                    record.morningWork = null;
                    record.afternoonWork = null;
                    record.overtime = null;
                }
            }

            // æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå·¥ä½œæ—¶é—´æ®µï¼ˆé™¤äº†å…¨å¤©è¯·å‡ï¼‰
            if (dayType !== 'leave' || record.leaveType !== 'all') {
                if (!record.morningWork && !record.afternoonWork && !record.overtime) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå·¥ä½œæ—¶é—´æ®µ');
                    return;
                }
            }

            // è®¡ç®—æ­£å¸¸å·¥ä½œæ—¶é•¿å’ŒåŠ ç­æ—¶é•¿
            calculateWorkTime(record);

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const records = getRecords();
            const existingIndex = records.findIndex(r => r.id === currentEditingId);
            if (existingIndex > -1) {
                records[existingIndex] = record; // æ›´æ–°è®°å½•
            }
            
            enhancedSetItem(getStorageKey(), records);
            
            // å–æ¶ˆç¼–è¾‘æ¨¡å¼
            cancelEdit();
            
            // åˆ·æ–°æ˜¾ç¤º
            displayRecords();
            updateStatistics();
            renderCalendar();
            alert('è®°å½•æ›´æ–°æˆåŠŸï¼');
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            currentEditingId = null;
            document.getElementById('saveButton').style.display = 'inline-block';
            document.getElementById('updateButton').style.display = 'none';
            document.getElementById('cancelButton').style.display = 'none';
            setDefaultDate();
            document.getElementById('dayType').value = 'work';
            toggleTimeInputs();
            resetTimeInputs();
            
            // ç¡®ä¿æ‰€æœ‰æ—¶é—´æ®µçš„æ˜¾ç¤ºçŠ¶æ€æ­£ç¡®
            toggleMorningWork();
            toggleAfternoonWork();
            toggleOvertime();
        }

        // é‡ç½®æ—¶é—´è¾“å…¥
        function resetTimeInputs() {
            document.getElementById('morningWorkCheck').checked = true;
            document.getElementById('afternoonWorkCheck').checked = true;
            
            // æ ¹æ®å½“å‰æ—¥æœŸè®¾ç½®åŠ ç­å‹¾é€‰çŠ¶æ€
            updateOvertimeCheckbox();
            
            document.getElementById('morningStart').value = '08:00';
            document.getElementById('morningEnd').value = '12:00';
            document.getElementById('afternoonStart').value = '13:30';
            document.getElementById('afternoonEnd').value = '17:30';
            document.getElementById('overtimeStart').value = '18:30';
            document.getElementById('overtimeEnd').value = '21:30';
            
            toggleMorningWork();
            toggleAfternoonWork();
            toggleOvertime();
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(id) {
            const records = getRecords();
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('è®°å½•ä¸å­˜åœ¨');
                return;
            }
            
            // è®¾ç½®ç¼–è¾‘æ¨¡å¼
            currentEditingId = id;
            document.getElementById('saveButton').style.display = 'none';
            document.getElementById('updateButton').style.display = 'inline-block';
            document.getElementById('cancelButton').style.display = 'inline-block';
            
            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('dateInput').value = record.date;
            document.getElementById('dayType').value = record.dayType;
            toggleTimeInputs();
            
            // é‡ç½®æ‰€æœ‰å¤é€‰æ¡†å’Œé€‰é¡¹
            document.getElementById('morningWorkCheck').checked = false;
            document.getElementById('afternoonWorkCheck').checked = false;
            document.getElementById('overtimeCheck').checked = false;
            
            // å¡«å……å·¥ä½œæ—¶é—´æ•°æ®
            if (record.morningWork) {
                document.getElementById('morningWorkCheck').checked = true;
                document.getElementById('morningStart').value = record.morningWork.start;
                document.getElementById('morningEnd').value = record.morningWork.end;
            }
            
            if (record.afternoonWork) {
                document.getElementById('afternoonWorkCheck').checked = true;
                document.getElementById('afternoonStart').value = record.afternoonWork.start;
                document.getElementById('afternoonEnd').value = record.afternoonWork.end;
            }
            
            if (record.overtime) {
                document.getElementById('overtimeCheck').checked = true;
                document.getElementById('overtimeStart').value = record.overtime.start;
                document.getElementById('overtimeEnd').value = record.overtime.end;
            }
            
            // è®¾ç½®è¯·å‡ç±»å‹
            if (record.leaveType) {
                document.querySelector(`input[name="leaveType"][value="${record.leaveType}"]`).checked = true;
            }
            
            // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
            toggleMorningWork();
            toggleAfternoonWork();
            toggleOvertime();
            
            // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„é€‰æ‹©å™¨æ»šåŠ¨åˆ°è¡¨å•åŒºåŸŸ
            document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                const records = getRecords().filter(record => record.id !== id);
                enhancedSetItem(getStorageKey(), records);
                displayRecords();
                updateStatistics();
                renderCalendar();
            }
        }

        // è·å–æ‰€æœ‰è®°å½•
        function getRecords() {
            const stored = enhancedGetItem(getStorageKey());
            return stored ? stored : [];
        }

        // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
        function displayRecords() {
            const records = getRecords();
            const recordsList = document.getElementById('recordsList');
            const sortOrder = document.getElementById('sortOrder').value;
            
            if (records.length === 0) {
                recordsList.innerHTML = '<div class="empty-message">æš‚æ— è®°å½•ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§ï¼</div>';
                return;
            }

            // æŒ‰æ—¥æœŸæ’åº
            let sortedRecords = [...records];
            if (sortOrder === 'desc') {
                sortedRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else {
                sortedRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
            
            // å¦‚æœé€‰æ‹©äº†ç‰¹å®šæœˆä»½ï¼Œåˆ™åªæ˜¾ç¤ºè¯¥æœˆä»½çš„è®°å½•
            let filteredRecords = sortedRecords;
            if (selectedMonth) {
                filteredRecords = sortedRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === selectedMonth.year && 
                           recordDate.getMonth() === selectedMonth.month;
                });
            }
            
            if (filteredRecords.length === 0) {
                recordsList.innerHTML = '<div class="empty-message">è¯¥æœˆä»½æš‚æ— è®°å½•</div>';
                return;
            }
            
            recordsList.innerHTML = filteredRecords.map(record => {
                // è®¡ç®—æ€»æ—¶é•¿
                const totalDuration = (record.morningWork ? record.morningWork.duration : 0) + 
                                     (record.afternoonWork ? record.afternoonWork.duration : 0) +
                                     (record.overtime ? record.overtime.duration : 0);
                
                return `
                <div class="record-item ${currentEditingId === record.id ? 'edit-mode' : ''}">
                    <div class="record-header">
                        <div class="record-date">
                            ${record.date}
                            <span class="weekday">${getWeekdayName(record.date)}</span>
                        </div>
                        <div class="button-group">
                            <button class="edit-btn" onclick="editRecord(${record.id})">ä¿®æ”¹</button>
                            <button class="delete-btn" onclick="deleteRecord(${record.id})">åˆ é™¤</button>
                        </div>
                    </div>
                    
                    ${record.dayType !== 'rest' ? `
                        <div class="time-blocks">
                            ${record.morningWork ? `
                                <div class="time-block normal-work">
                                    <div class="block-title">ä¸Šåˆå·¥ä½œ</div>
                                    <div class="block-time">${record.morningWork.start} - ${record.morningWork.end}</div>
                                    <div class="block-duration">${formatDuration(record.morningWork.duration)}</div>
                                </div>
                            ` : ''}
                            
                            ${record.afternoonWork ? `
                                <div class="time-block normal-work">
                                    <div class="block-title">ä¸‹åˆå·¥ä½œ</div>
                                    <div class="block-time">${record.afternoonWork.start} - ${record.afternoonWork.end}</div>
                                    <div class="block-duration">${formatDuration(record.afternoonWork.duration)}</div>
                                </div>
                            ` : ''}
                            
                            ${record.overtime ? `
                                <div class="time-block overtime">
                                    <div class="block-title">æ™šä¸ŠåŠ ç­</div>
                                    <div class="block-time">${record.overtime.start} - ${record.overtime.end}</div>
                                    <div class="overtime-duration">${formatDuration(record.overtime.duration)}</div>
                                </div>
                            ` : ''}
                            
                            ${record.leaveType ? `
                                <div class="time-block leave-block">
                                    <div class="block-title">è¯·å‡ä¿¡æ¯</div>
                                    <div class="block-time">
                                        ${record.leaveType === 'all' ? 'å…¨å¤©è¯·å‡' : 
                                          record.leaveType === 'morning' ? 'ä¸Šåˆè¯·å‡' : 'ä¸‹åˆè¯·å‡'}
                                    </div>
                                    <div class="leave-duration">
                                        ${record.leaveType === 'all' ? '1å¤©' : '0.5å¤©'}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${record.dayType === 'leave' && record.leaveType !== 'all' ? `
                            <div class="record-total">
                                æ­£å¸¸å·¥ä½œæ—¶é•¿: ${formatDuration(record.normalDuration)} | 
                                åŠ ç­æ—¶é•¿: <span class="overtime-duration">${formatDuration(record.overtimeDuration)}</span> |
                                æ€»æ—¶é•¿: ${formatDuration(totalDuration)}
                            </div>
                        ` : record.dayType === 'work' ? `
                            <div class="record-total">
                                æ­£å¸¸å·¥ä½œæ—¶é•¿: ${formatDuration(record.normalDuration)} | 
                                åŠ ç­æ—¶é•¿: <span class="overtime-duration">${formatDuration(record.overtimeDuration)}</span> |
                                æ€»æ—¶é•¿: ${formatDuration(totalDuration)}
                            </div>
                        ` : ''}
                    ` : `
                        <div style="color: #27ae60; font-style: italic;">ğŸ’¤ ä¼‘æ¯æ—¥</div>
                    `}
                </div>
                `;
            }).join('');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const records = getRecords();
            
            // æ ¹æ®é€‰æ‹©çš„æœˆä»½ç­›é€‰è®°å½•
            let filteredRecords = records;
            if (selectedMonth) {
                filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === selectedMonth.year && 
                           recordDate.getMonth() === selectedMonth.month;
                });
            }
            
            // å·¥ä½œå¤©æ•°ï¼ˆæœ‰å·¥ä½œè®°å½•çš„æ—¥æœŸï¼‰
            const workDays = filteredRecords.filter(r => r.dayType === 'work').length;
            
            // ä¼‘æ¯å¤©æ•°
            const restDays = filteredRecords.filter(r => r.dayType === 'rest').length;
            
            // è¯·å‡æ—¶é—´ï¼ˆå°æ—¶ï¼‰
            let totalLeaveHours = 0;
            filteredRecords.forEach(record => {
                if (record.dayType === 'leave') {
                    if (record.leaveType === 'all') {
                        totalLeaveHours += 8; // å…¨å¤©è¯·å‡ç®—8å°æ—¶
                    } else {
                        totalLeaveHours += 4; // åŠå¤©è¯·å‡ç®—4å°æ—¶
                    }
                }
            });
            
            // åŠ ç­æ—¶é—´ - ä½¿ç”¨è®°å½•çš„overtimeDurationå­—æ®µ
            let totalOvertimeHours = 0;
            filteredRecords.forEach(record => {
                totalOvertimeHours += (record.overtimeDuration || 0) / 60;
            });

            document.getElementById('totalWorkDays').textContent = workDays + ' å¤©';
            document.getElementById('totalLeaveHours').textContent = totalLeaveHours.toFixed(1) + ' å°æ—¶';
            document.getElementById('totalRestDays').textContent = restDays + ' å¤©';
            document.getElementById('totalOvertimeHours').textContent = totalOvertimeHours.toFixed(1) + ' å°æ—¶';
            
            // æ›´æ–°ç»Ÿè®¡æ ‡é¢˜
            if (selectedMonth) {
                document.getElementById('statsTitle').textContent = 
                    `${selectedMonth.year}å¹´${selectedMonth.month + 1}æœˆç»Ÿè®¡æ±‡æ€»`;
            } else {
                document.getElementById('statsTitle').textContent = 'æœ¬æœˆç»Ÿè®¡æ±‡æ€»';
            }
        }

        // åˆ¤æ–­æ—¥æœŸæ˜¯å¦åœ¨å½“å‰ç»Ÿè®¡å‘¨æœŸå†…
        function isDateInCurrentPeriod(dateStr) {
            const periodRange = getCurrentPeriodRange();
            const recordDate = new Date(dateStr);
            // å°†è®°å½•æ—¥æœŸè®¾ç½®ä¸ºå½“å¤©çš„23:59:59ï¼Œç¡®ä¿åŒ…å«å½“å¤©
            recordDate.setHours(23, 59, 59, 999);
            return recordDate >= periodRange.start && recordDate <= periodRange.end;
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarTitle = document.getElementById('calendarTitle');
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // è®¾ç½®æ—¥å†æ ‡é¢˜
            calendarTitle.textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0æ˜¯å‘¨æ—¥ï¼Œ6æ˜¯å‘¨å…­ï¼‰
            const firstDayOfWeek = firstDay.getDay();
            
            // è·å–ä¸Šä¸ªæœˆçš„æœ€åå‡ å¤©
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            // æ¸…ç©ºæ—¥å†
            calendarGrid.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-weekday';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            });
            
            // æ·»åŠ ä¸Šä¸ªæœˆçš„æ—¥æœŸ
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `
                    <div class="day-number">${prevMonthLastDay - i}</div>
                `;
                calendarGrid.appendChild(dayElement);
            }
            
            // æ·»åŠ å½“æœˆçš„æ—¥æœŸ
            const records = getRecords();
            const today = new Date();
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const record = records.find(r => r.date === dateStr);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
                if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === day) {
                    dayElement.classList.add('today');
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å½“å‰ç»Ÿè®¡å‘¨æœŸå†…
                if (isDateInCurrentPeriod(dateStr)) {
                    dayElement.classList.add('period-day');
                }
                
                let statusText = '';
                let statusClass = '';
                
                if (record) {
                    if (record.dayType === 'work') {
                        statusText = 'å·¥ä½œ';
                        statusClass = 'work-status';
                    } else if (record.dayType === 'leave') {
                        statusText = record.leaveType === 'all' ? 'å…¨å¤©å‡' : 
                                   record.leaveType === 'morning' ? 'ä¸Šåˆå‡' : 'ä¸‹åˆå‡';
                        statusClass = 'leave-status';
                    } else if (record.dayType === 'rest') {
                        statusText = 'ä¼‘æ¯';
                        statusClass = 'rest-status';
                    }
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${statusText ? `<div class="day-status ${statusClass}">${statusText}</div>` : ''}
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                dayElement.onclick = () => {
                    document.getElementById('dateInput').value = dateStr;
                    // è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„æ—¥æœŸç±»å‹
                    if (record) {
                        document.getElementById('dayType').value = record.dayType;
                        toggleTimeInputs();
                    }
                    updateOvertimeCheckbox(); // æ›´æ–°åŠ ç­å¤é€‰æ¡†çŠ¶æ€
                };
                
                calendarGrid.appendChild(dayElement);
            }
            
            // æ·»åŠ ä¸‹ä¸ªæœˆçš„æ—¥æœŸï¼ˆè¡¥é½å‰©ä½™æ ¼å­ï¼‰
            const totalCells = 42; // 6è¡Œ * 7åˆ—
            const remainingCells = totalCells - firstDayOfWeek - lastDay.getDate();
            
            for (let day = 1; day <= remainingCells; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                `;
                calendarGrid.appendChild(dayElement);
            }
        }

        // åˆ‡æ¢æœˆä»½
        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        // å¯¼å‡ºä¸ºExcel
        function exportToExcel() {
            const records = getRecords();
            if (records.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            // æ’åºè®°å½•
            records.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // åˆ›å»ºCSVå†…å®¹
            let csv = 'æ—¥æœŸ,æ˜ŸæœŸ,ç±»å‹,è¯·å‡ç±»å‹,ä¸Šåˆå·¥ä½œæ—¶é—´,ä¸Šåˆå·¥ä½œæ—¶é•¿,ä¸‹åˆå·¥ä½œæ—¶é—´,ä¸‹åˆå·¥ä½œæ—¶é•¿,åŠ ç­æ—¶é—´,åŠ ç­æ—¶é•¿,æ­£å¸¸å·¥ä½œæ—¶é•¿,åŠ ç­æ—¶é•¿,æ€»å·¥ä½œæ—¶é•¿\n';
            
            records.forEach(record => {
                const type = record.dayType === 'work' ? 'å·¥ä½œæ—¥' : record.dayType === 'leave' ? 'è¯·å‡' : 'ä¼‘æ¯æ—¥';
                const leaveType = record.leaveType ? 
                    (record.leaveType === 'all' ? 'å…¨å¤©è¯·å‡' : 
                     record.leaveType === 'morning' ? 'ä¸Šåˆè¯·å‡' : 'ä¸‹åˆè¯·å‡') : '';
                const morningTime = record.morningWork ? `${record.morningWork.start}-${record.morningWork.end}` : '';
                const morningHours = record.morningWork ? (record.morningWork.duration / 60).toFixed(1) : '';
                const afternoonTime = record.afternoonWork ? `${record.afternoonWork.start}-${record.afternoonWork.end}` : '';
                const afternoonHours = record.afternoonWork ? (record.afternoonWork.duration / 60).toFixed(1) : '';
                const overtime = record.overtime ? `${record.overtime.start}-${record.overtime.end}` : '';
                const overtimeHours = record.overtime ? (record.overtime.duration / 60).toFixed(1) : '';
                const normalHours = (record.normalDuration / 60).toFixed(1);
                const overtimeTotalHours = (record.overtimeDuration / 60).toFixed(1);
                
                const totalHours = ((record.morningWork ? record.morningWork.duration : 0) + 
                                   (record.afternoonWork ? record.afternoonWork.duration : 0) +
                                   (record.overtime ? record.overtime.duration : 0)) / 60;
                
                csv += `"${record.date}","${getWeekdayName(record.date)}","${type}","${leaveType}","${morningTime}","${morningHours}","${afternoonTime}","${afternoonHours}","${overtime}","${overtimeHours}","${normalHours}","${overtimeTotalHours}","${totalHours.toFixed(1)}"\n`;
            });

            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            const periodRange = getCurrentPeriodRange();
            const startDate = `${periodRange.start.getFullYear()}-${periodRange.start.getMonth()+1}-${periodRange.start.getDate()}`;
            const endDate = `${periodRange.end.getFullYear()}-${periodRange.end.getMonth()+1}-${periodRange.end.getDate()}`;
            
            csv += `\n\nç»Ÿè®¡å‘¨æœŸ: ${startDate} è‡³ ${endDate}\n`;
            csv += `å·¥ä½œå¤©æ•°,${document.getElementById('totalWorkDays').textContent}\n`;
            csv += `è¯·å‡æ—¶é—´,${document.getElementById('totalLeaveHours').textContent}\n`;
            csv += `ä¼‘æ¯å¤©æ•°,${document.getElementById('totalRestDays').textContent}\n`;
            csv += `åŠ ç­æ—¶é—´,${document.getElementById('totalOvertimeHours').textContent}\n`;

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å·¥ä½œè®°å½•_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‚¨çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // æ¸…é™¤æ‰€æœ‰å­˜å‚¨çš„æ•°æ®
                const userId = getUserId();
                const keys = [
                    getStorageKey(),
                    'lastPunchTime_' + userId,
                    'periodSettings_' + userId,
                    'workRecordUserId',
                    'autoBackup',
                    'lastBackupTime'
                ];
                
                keys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                    // æ¸…é™¤ IndexedDB æ•°æ®
                    if (db) {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        store.delete(key);
                    }
                    // æ¸…é™¤ Cookie
                    document.cookie = key + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                });
                
                displayRecords();
                updateStatistics();
                renderCalendar();
                document.getElementById('lastPunchTime').textContent = 'ä»Šæ—¥å°šæœªæ‰“å¡';
                cancelEdit(); // æ¸…ç©ºç¼–è¾‘çŠ¶æ€
                showDataStatus(); // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            }
        }

        // ==================== æœˆä»½é€‰æ‹©åŠŸèƒ½ ====================
        
        // æ›´æ–°é€‰æ‹©çš„æœˆä»½ç»Ÿè®¡
        function updateSelectedMonthStats() {
            const monthInput = document.getElementById('statMonth').value;
            if (!monthInput) {
                alert('è¯·é€‰æ‹©æœˆä»½');
                return;
            }
            
            const [year, month] = monthInput.split('-').map(Number);
            selectedMonth = { year, month: month - 1 }; // æœˆä»½ä»0å¼€å§‹
            
            // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
            document.getElementById('selectedMonthInfo').textContent = 
                `å½“å‰æ˜¾ç¤ºï¼š${year}å¹´${month}æœˆç»Ÿè®¡æ•°æ®`;
            
            // æ›´æ–°ç»Ÿè®¡å’Œè®°å½•åˆ—è¡¨
            updateStatistics();
            displayRecords();
        }

        // ==================== åŠŸèƒ½åŒºåŸŸå±•å¼€/æ”¶ç¼© ====================
        
        // åˆ‡æ¢æ‰€æœ‰åŠŸèƒ½åŒºåŸŸ
        function toggleAllFunctions() {
            const content = document.getElementById('allFunctionsContent');
            const toggle = document.getElementById('allFunctionsToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }
        
        // åˆ‡æ¢å…·ä½“åŠŸèƒ½åŒºåŸŸ
        function toggleFunction(functionId) {
            const content = document.getElementById(functionId + 'Content');
            const toggle = document.getElementById(functionId + 'Toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }

        // ==================== æ•°æ®å¤‡ä»½åŠŸèƒ½ ====================
        
        // å¯¼å‡ºæ•°æ®å¤‡ä»½
        function exportBackup() {
            const backupData = {
                records: getRecords(),
                periodSettings: getPeriodSettings(),
                lastPunchTime: enhancedGetItem('lastPunchTime_' + getUserId()),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `å·¥ä½œæ—¶é—´ç»Ÿè®¡å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            
            // æ›´æ–°æœ€åå¯¼å‡ºæ—¶é—´
            enhancedSetItem('lastExportTime', Date.now());
            alert('å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼å»ºè®®å°†å¤‡ä»½æ–‡ä»¶ä¿å­˜åˆ°å®‰å…¨çš„ä½ç½®ï¼ˆå¦‚äº‘ç›˜ã€å¤–éƒ¨å­˜å‚¨è®¾å¤‡ï¼‰ã€‚');
        }
        
        // å¯¼å…¥æ•°æ®å¤‡ä»½
        function importBackup() {
            document.getElementById('backupFileInput').click();
        }
        
        // å¤„ç†å¤‡ä»½æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('backupFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!confirm('å¯¼å…¥å¤‡ä»½å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                        return;
                    }
                    
                    // æ¢å¤æ•°æ®
                    if (backupData.records) {
                        enhancedSetItem(getStorageKey(), backupData.records);
                    }
                    
                    if (backupData.periodSettings) {
                        enhancedSetItem('periodSettings_' + getUserId(), backupData.periodSettings);
                    }
                    
                    if (backupData.lastPunchTime) {
                        enhancedSetItem('lastPunchTime_' + getUserId(), backupData.lastPunchTime);
                    }
                    
                    // åˆ·æ–°æ˜¾ç¤º
                    enhancedInit();
                    alert('æ•°æ®æ¢å¤æˆåŠŸï¼');
                    
                } catch (error) {
                    alert('å¤‡ä»½æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•å¯¼å…¥');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            e.target.value = '';
        });

        // ==================== æ•°æ®æ˜¾ç¤ºåŠŸèƒ½ ====================

        // æ˜¾ç¤ºæ•°æ®çŠ¶æ€
        function showDataStatus() {
            const records = getRecords();
            const backupTime = enhancedGetItem('lastBackupTime');
            const backupDate = backupTime ? new Date(backupTime).toLocaleString() : 'æ— ';
            const storageTypes = [];
            
            // æ£€æŸ¥å„ç§å­˜å‚¨æ–¹å¼
            if (localStorage.getItem(getStorageKey())) storageTypes.push('localStorage');
            if (sessionStorage.getItem(getStorageKey())) storageTypes.push('sessionStorage');
            if (db) storageTypes.push('IndexedDB');
            if (getCookie(getStorageKey())) storageTypes.push('Cookie');
            
            const statusElement = document.getElementById('dataStatus');
            if (!statusElement) return;
            
            if (records.length > 0) {
                statusElement.innerHTML = `
                    <div>ğŸ“Š å·²ä¿å­˜ <strong>${records.length}</strong> æ¡å·¥ä½œè®°å½•</div>
                    <div>ğŸ”„ æœ€åå¤‡ä»½: <strong>${backupDate}</strong></div>
                    <div>ğŸ’¾ å­˜å‚¨æ–¹å¼: <strong>${storageTypes.join(', ')}</strong></div>
                    <div style="font-size: 12px; margin-top: 5px; color: #666;">
                        æ•°æ®å·²é€šè¿‡å¤šé‡å¤‡ä»½æœºåˆ¶ä¿æŠ¤ï¼Œå¤§å¤§é™ä½ä¸¢å¤±é£é™©
                    </div>
                `;
            } else {
                statusElement.innerHTML = `
                    <div>ğŸ“Š æš‚æ— å·¥ä½œè®°å½•</div>
                    <div>ğŸ’¾ å­˜å‚¨æ–¹å¼: <strong>${storageTypes.join(', ')}</strong></div>
                    <div style="font-size: 12px; margin-top: 5px; color: #666;">
                        ç³»ç»Ÿä½¿ç”¨å¤šé‡å¤‡ä»½æœºåˆ¶ä¿æŠ¤æ‚¨çš„æ•°æ®
                    </div>
                `;
            }
        }

        // ==================== å¢å¼ºåˆå§‹åŒ–å‡½æ•° ====================

        // å¢å¼ºçš„åˆå§‹åŒ–å‡½æ•°
        async function enhancedInit() {
            try {
                // åˆå§‹åŒ– IndexedDB
                await initIndexedDB();
                
                // å°è¯•è‡ªåŠ¨æ¢å¤æ•°æ®
                const recovered = autoRecoverData();
                if (recovered) {
                    console.log('æ•°æ®å·²ä»å¤‡ä»½æ¢å¤');
                }
                
                // åˆå§‹åŒ–è‡ªåŠ¨å¤‡ä»½
                initAutoBackup();
                
                // åŸæœ‰çš„åˆå§‹åŒ–ä»£ç 
                setDefaultDate();
                toggleTimeInputs();
                
                // åŠ è½½ç»Ÿè®¡å‘¨æœŸè®¾ç½®
                const settings = getPeriodSettings();
                const periodStartDayElement = document.getElementById('periodStartDay');
                if (periodStartDayElement) {
                    periodStartDayElement.value = settings.startDay;
                }
                updatePeriodInfo();
                
                // è®¾ç½®å½“å‰æœˆä»½ä¸ºé»˜è®¤é€‰æ‹©
                const today = new Date();
                const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
                document.getElementById('statMonth').value = currentMonth;
                
                // æ·»åŠ æ—¥æœŸå˜åŒ–ç›‘å¬
                document.getElementById('dateInput').addEventListener('change', updateOvertimeCheckbox);
                
                displayRecords();
                updateStatistics();
                renderCalendar();
                updateLastPunchTime();
                
                // æ˜¾ç¤ºæ•°æ®çŠ¶æ€
                showDataStatus();
                
                console.log('ç³»ç»Ÿå¢å¼ºåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('å¢å¼ºåˆå§‹åŒ–å¤±è´¥:', error);
                // å›é€€åˆ°æ™®é€šåˆå§‹åŒ–
                init();
            }
        }

        // åŸæœ‰çš„åˆå§‹åŒ–å‡½æ•°ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
        function init() {
            setDefaultDate();
            toggleTimeInputs();
            
            // åŠ è½½ç»Ÿè®¡å‘¨æœŸè®¾ç½®
            const settings = getPeriodSettings();
            const periodStartDayElement = document.getElementById('periodStartDay');
            if (periodStartDayElement) {
                periodStartDayElement.value = settings.startDay;
            }
            updatePeriodInfo();
            
            // è®¾ç½®å½“å‰æœˆä»½ä¸ºé»˜è®¤é€‰æ‹©
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            document.getElementById('statMonth').value = currentMonth;
            
            // æ·»åŠ æ—¥æœŸå˜åŒ–ç›‘å¬
            document.getElementById('dateInput').addEventListener('change', updateOvertimeCheckbox);
            
            displayRecords();
            updateStatistics();
            renderCalendar();
            updateLastPunchTime();
            
            // æ˜¾ç¤ºæ•°æ®çŠ¶æ€
            showDataStatus();
        }

        // ==================== é¡µé¢åŠ è½½äº‹ä»¶ ====================

        // æ›´æ–°é¡µé¢åŠ è½½äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            window._domReady = true;
            setTimeout(enhancedInit, 50);
        });

        window.onload = function() {
            if (!window._domReady) {
                setTimeout(enhancedInit, 100);
            }
        };
    </script>
</body>
</html>
